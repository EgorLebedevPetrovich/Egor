---
sidebar_position: 2
---

# Управление правилами доступа к непаллетной норме

Функциональность заказа продукции в непаллетной норме позволяет пользователям заказать продукцию, которая хранится на складе не в паллетах, а в штуках (нераспроданные остатки). 

Данная функциональность реализована в системе с помощью механизма управления правилами доступа контрагента к непаллетной норме.

Правила доступа настраиваются администратором системы в административной части Личного кабинета. Правила определяют перечень продукции и количество продукции в непаллетной норме, 
доступной для оформления Заявки. Возможность запросить продукцию в непаллетной норме доступна только при оформлении Ресурсной Заявки соответствующего типа.

Правила доступа включают в себя следующие параметры:

-	Контрагент, к которому применяется правило. В один момент времени правило доступно только одному контрагенту. В будущем не должно быть ограничений для предоставления данных нескольким контрагентам одновременно.
-	Срок действия правила. Срок действия устанавливается вручную и определяет дату и время, в которые правило будет деактивировано.
-	Список продукции. Каждое правило включает в себя список продукции, доступной для заказа. Для каждой продукции устанавливаются:
-	Количество. Определяет максимально доступное для заказа количество продукции.
-	Склад отгрузки. Параметр определяет с какого склада доступна отгрузка.
-	Активность. Параметр определяет действует правило или нет. По умолчанию все правила создаются активными.

Управление правилами в ЛКК осуществляется вручную администратором системы в административной панели 1С Битрикс. На данном этапе не предусмотрено интеграции по этим данным с АСКУ.

Настройка правил доступа к товарам в непаллетной норме происходит следующими способами: 

-	Массовое добавление путем загрузки xlsx-файла со списком продуктов для каждого правила. Для этого на странице редактирования правила предусмотрен интерфейс загрузки файла. Файл формируется по определенному шаблону.

-	Обновление текущего списка путем загрузки xlsx-файла со обновленным полным списком продуктов. 
-	Ручное управление отдельными пунктами правил в административном интерфейсе Битрикс. При ручном управлении допускается создание, редактирование и деактивация пунктов правил. 

Каждое правило определяет наличие доступа к товару на определенном складе отгрузки для текущего контрагента. 

Правила применения прав доступа:

-	Правила предоставляют доступ к товарам, указанным в списке правил.
-	Для любого контрагента при этом также действуют ограничения по текущему договору контрагента. Доступ к товарам правила открыт только в том случае, если параметры товара не противоречат ограничениям договора.

Для обеспечения функциональности в системе настраиваются следующие объекты:

-	Непаллетная норма. Параметры доступа (справочник создается базе HL-блока 1С-Битрикс): определяют контрагентов, к которым применяется правило.
-	Непаллетная норма. Правила (справочник создается базе HL-блока 1С-Битрикс): определяют список продуктов, доступных для заказа в рамках правила.

## Требования к шаблону загрузки

Шаблон файла строго регламентирован.

Ограничение на максимальное количество строк с товарными позициями в файле – 10 000. В связи с необходимостью обработки большого количества данных, скорость обработки для 
пользователя может быть продолжительной и составлять несколько минут.

Формат файла – xlsx.

Структура шаблона:

№|Заголовок столбца|Назначение|Обязательность
:-:|:-:|:-:|:-:
1|	Код продукта|	Указан артикул товара (SKU), соответствующий коду товара в АСКУ |	Да
2|	Объем	Объем, доступный для заказа в штуках|	Да
3|	Название склада отгрузки|	Наименование склада отгрузки, для которого применяется правило|	Да 

Проверка и обработка файла выполняется следующим образом:

1	Сначала выполняется проверка файла на соответствие формату и требованиям, описанным выше. 
2	Если в строке не заполнены обязательные поля, то отображается ошибка «Строка № <номер строки в файле> не содержит необходимые данные» и обработка переходит на следующую строку
3	Если указанная выше проверка прошла успешно, выполняется проверка содержимого файла на наличие в каталоге продукции.
4	Обработка существующих правил и запись новых осуществляется для товаров, присутствующих в каталоге продукции происходит в соответствии с выбранным действием:

1	Сценарий для кнопки «Обновить»:

-	Если правило есть в группе, но отсутствует в шаблоне, оно деактивируется.
-	Если правило есть в группе и есть в шаблоне, то:
-	Если оно активно, то оно остается неизменным
-	Если оно неактивно, то оно активируется
-	Новые правила записываются только если они не были найдены в списке существующих правил группы.
 
      2. Сценарий для кнопки «Добавить»:

-	Если правило есть в группе, но отсутствует в шаблоне, оно не меняется.
-	Если правило есть в группе и есть в шаблоне, то:
-	Если оно активно, то оно остается неизменным
-	Если оно неактивно, то оно активируется
-	Новые правила записываются только если они не были найдены в списке существующих правил группы.

Загрузка файла в систему реализуется в режиме реального времени. На время загрузки файла в интерфейсе предусмотрено отображение полосы загрузки (прогрессбара) и прочей информации о процессе загрузки. Также на время загрузки файла допускается параллельная работа с административным интерфейсом ЛК в отдельной вкладке браузера.

Обработка ошибок:

1.	Разрешена загрузка файлов в форматах xlsx. В случае загрузки файла в отличном от разрешенного формате, отображается сообщение об ошибке #ОШ10  в интерфейсе загрузки файла, обработка файла при этом не происходит.
2.	Если количество строк в файле превышает допустимый лимит в 10000 строк продукции, отображается текстовое уведомление об ошибке #ОШ11. Обработка файла прерывается. 
3.	Товарные позиции, артикулы которых не имеют совпадений с товарами в Каталоге, не выводятся в списке позиций, артикулы данных позиций отображается сообщение об ошибке #ОШ16.

Результаты обработки файла сохраняются в справочнике «Товары в непаллетной норме».

