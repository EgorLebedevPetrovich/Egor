---
sidebar_position: 1
---

# Управление отображением ассортимента для контрагентов

Функциональность групп контрагентов дает возможность администраторам системы организовать гибкую настройку прав доступа контрагентов к товарам торгового каталога. Данная настройка влияет на ограничение ассортимента, отображаемого в интерфейсе создания заявки контрагентов. Функциональность включает в себя:

-	создание и редактирование групп контрагентов;
-	настройка иерархии групп;
-	подключение контрагентов к группам;
-	определение для каждой группы прав доступа к товарам торгового каталога.

Для обеспечения функциональности в системе настраиваются следующие объекты:

-	Группы контрагентов (справочник создается базе HL-блока 1С-Битрикс): определяют иерархию групп контрагентов
-	Ограничение ассортимента (справочник создается базе HL-блока 1С-Битрикс): определяют правила доступа к товару в разрезе группы контрагентов

##	 Группы контрагентов

Группы контрагентов обладают следующими параметрами:

-	Название группы: для отображения в административном интерфейсе.
-	Родительская группа: связь с группой первого уровня для групп второго уровня. Если параметр пустой, то группа принадлежит к верхнему уровню. По умолчанию родительская группа не указана.

Иерархия групп контрагентов в ЛКК настраивается вручную администратором системы в административной панели 1С Битрикс. 

Правила создания иерархии:

-	В структуре предусмотрено два уровня вложенности (организационное ограничение).
-	На верхнем уровне можно создать неограниченное количество групп.
-	У каждой группы второго уровня может быть только один родитель.
-	У каждой группы верхнего уровня может быть неограниченное количество вложенных групп.

Подключение контрагентов производится вручную администратором системы в административной панели 1С Битрикс.

Правила подключения контрагентов:

-	По умолчанию контрагент не подключен ни к одной группе и имеет доступ ко всем товарам каталога (с учетом условий договора контрагента)
-	Каждый контрагент может принадлежать только к одной группе любого уровня вложенности. 

##	 Настройка прав доступа к товарам каталога

Настройка прав доступа к товарам осуществляется следующими способами: 

1.	Массовая загрузка прав путем загрузки xlsx-файла со списком правил для каждой группы контрагентов. Для этого на странице редактирования группы предусмотрен интерфейс загрузки файла. Файл формируется по определенному шаблону, описанному в п. 3.7.1.2.1.
2.	Массовая загрузка прав путем загрузки xlsx-файла со списком правил одновременно для нескольких групп контрагентов. Список групп формируется вручную администратором в интерфейсе загрузки файла. При этом одинаковый набор правил применяется ко всем указанным группам.
3.	Обновление текущего списка правил путем загрузки xlsx-файла со обновленным полным списком правил для одной или нескольких групп контрагентов. Подробнее сценарий обновления правил описан в п. 3.7.1.2.1.
4.	Ручное управление отдельными правилами в административном интерфейсе Битрикс. При ручном управлении допускается создание, редактирование и деактивация правил. Деактивация правил осуществляется при ручном управлении в административном интерфейсе на уровне группы.

Каждое правило определяет наличие доступа к товару на определенном складе отгрузки для текущей группы контрагентов. 

Правила применения прав доступа:

-	Правила групп контрагентов предоставляют доступ к товарам, указанным в списке правил.
-	Правила вложенной группы расширяют правила группы-родителя.
-	Доступ к товарам, не указанным в списке правил текущей группы, по умолчанию закрыт.
-	Для любого контрагента, кроме правил группы, действуют ограничения по текущему договору контрагента. Доступ к товарам группы открыт только в том случае, если параметры товара не противоречат ограничениям договора.

###	Требования к шаблону загрузки прав доступа

Шаблон файла строго регламентирован.

Ограничение на максимальное количество строк с товарными позициями в файле – 10 000. В связи с необходимостью обработки большого количества данных, скорость обработки для 
пользователя может быть продолжительной и составлять несколько минут.

Формат файла – xlsx.

Структура шаблона:

№|Заголовок столбца|Назначение|Обязательность
:-:|:-:|:-:|:-:
1|	Код продукта|	Указан артикул товара (SKU), соответствующий коду товара в АСКУ |	Да
2|	Название продукта|	Наименование товара	|Нет
3|	Название склада отгрузки|	Наименование склада отгрузки, для которого применяется правило|	Нет. Если склад не указан, то правило сохраняется с пустым складом. В интерфейсе создания Заявки данное правило будет действовать для всех складов отгрузки. 

Проверка и обработка файла выполняется следующим образом:

1.	Сначала выполняется проверка файла на соответствие формату и требованиям, описанным выше. 
2.	Если в строке не заполнены обязательные поля, то отображается ошибка «Строка № <номер строки в файле> не содержит код продукта» и обработка переходит на следующую строку
3.	Если указанная выше проверка прошла успешно, выполняется проверка содержимого файла на наличие в каталоге продукции.
4.	Обработка существующих правил и запись новых осуществляется для товаров, присутствующих в каталоге продукции происходит в соответствии с выбранным действием:

1.	Сценарий для кнопки «Обновить»:

-	Если правило есть в группе, но отсутствует в шаблоне, оно деактивируется.
-	Если правило есть в группе и есть в шаблоне, то:
-	Если оно активно, то оно остается неизменным.
-	Если оно неактивно, то оно активируется.
-	Новые правила записываются только если они не были найдены в списке существующих правил группы.
 
      2. Сценарий для кнопки «Добавить»:
-	Если правило есть в группе, но отсутствует в шаблоне, оно не меняется.
-	Если правило есть в группе и есть в шаблоне, то:
-	Если оно активно, то оно остается неизменным.
-	Если оно неактивно, то оно активируется.
-	Новые правила записываются только если они не были найдены в списке существующих правил группы.
 
      3. Сценарий для кнопки «Деактивировать»:
-	Если правило есть в группе, но отсутствует в шаблоне, оно не меняется.
-	Если правило есть в группе и есть в шаблоне, то:
-	Если оно активно, то оно деактивируется.
-	Если оно неактивно, то оно остается неизменным.
-	Если правило есть в шаблоне, но отсутствует в группе, то оно не записывается.

Загрузка файла в систему реализуется в режиме реального времени. На время загрузки файла в интерфейсе предусмотрено отображение полосы загрузки (прогрессбара) и прочей информации о процессе загрузки. Также на время загрузки файла допускается параллельная работа с административным интерфейсом ЛК в отдельной вкладке браузера.

Обработка ошибок:

1.	Разрешена загрузка файлов в форматах xlsx. В случае загрузки файла в отличном от разрешенного формате, отображается сообщение об ошибке #ОШ10  в интерфейсе загрузки файла, обработка файла при этом не происходит.
2.	Если количество строк в файле превышает допустимый лимит в 10000 строк продукции, отображается текстовое уведомление об ошибке #ОШ11. Обработка файла прерывается. 
3.	Товарные позиции, артикулы которых не имеют совпадений с товарами в Каталоге, не выводятся в списке позиций, артикулы данных позиций отображается сообщение об ошибке #ОШ16.

Результаты обработки файла сохраняются в справочнике «Ограничение ассортимента».
